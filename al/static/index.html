<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-VJM20CG19B"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VJM20CG19B');
  </script>
  <title>LearnUs Alimi</title>
  <!-- <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EüìÖ%3C/text%3E%3C/svg%3E" /> -->
  <link rel="icon" src="/icons/al.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --primary-gradient-start: #4e54c8;
      --primary-gradient-end: #8f94fb;
    }

    body {
      background: linear-gradient(135deg, #eef2ff 0%, #fafcff 100%);
      font-family: 'Poppins', 'Noto Sans KR', sans-serif;
    }

    h1 {
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary-gradient-start), var(--primary-gradient-end));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      max-width: 900px;
      margin: 0 auto 1.5rem auto;
      padding-left: 0.75rem; /* slight indent */
    }

    /* Login card */
    #login-form {
      max-width: 600px;
      margin: 0 auto 2rem;
      background: #fff;
      border-radius: 1rem;
      padding: 2rem;
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
    }

    /* Login form elements */
    #login-form .input-group-text {
      background: transparent;
      border-right: 0;
    }

    #login-form .form-control {
      border-left: 0;
      box-shadow: none !important;
    }

    #login-form .btn-primary {
      background: linear-gradient(90deg, var(--primary-gradient-start), var(--primary-gradient-end));
      border: none;
      font-weight: 600;
    }

    #login-form .btn-primary:hover {
      opacity: 0.9;
    }

    /* Footer */
    /* #footer {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.875rem;
      color: #6c757d;
      text-align: center;
    } */
    #footer {
      font-size: 0.875rem;
      color: #6c757d;
      text-align: center;
      margin: 1rem auto 1rem;
      max-width: 900px;
    }

    /* Course selector & Todo wrapper */
    #course-section,
    #todo-section {
      max-width: 900px;
      margin: 0 auto;
    }

    #course-section {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.05);
    }

    /* Todo lists styling */
    #todo-section .col-12 {
      margin-bottom: 3.5rem; /* increased gap */
    }

    /* Remaining time badge */
    .remaining-time {
      background: #f1f3f5 !important;
      color: #495057 !important;
      font-weight: 600;
    }

    /* Fixed width for due datetime badge so remaining badge stays aligned */
    .due-time {
      min-width: 10rem; /* adjust as needed */
      text-align: center;
    }

    #todo-section h4 {
      font-weight: 600;
      margin-bottom: 0.75rem;
    }

    #todo-section ul.list-group {
      border: 0;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.05);
    }

    /* Calendar card */
    #calendar {
      max-width: 900px;
      margin: 10px auto 20px;
      background: #fff;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
    }

    #loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1050;
      visibility: hidden;
    }

    #subtitle {
      max-width: 900px;
      margin: -1rem auto 2rem auto; /* slight pull-up to close gap, then bottom space */
      padding-left: 0.75rem;
    }

    /* Logout button hover and disabled styles */
    #logoutBtn, #homeBtn {
      transition: background-color 0.15s ease;
    }

    #logoutBtn:hover,
    #logoutBtn:focus,
    #homeBtn:hover,
    #homeBtn:focus {
      background-color: rgba(0, 0, 0, 0.05); /* subtle darkening */
    }

    #logoutBtn.disabled,
    #logoutBtn:disabled,
    #homeBtn.disabled,
    #homeBtn:disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    /* ----- FullCalendar badge hover expansion ----- */
    .fc-daygrid-event-harness:hover {
      overflow: visible; /* allow badge to extend outside cell */
    }

    .fc-daygrid-event.fc-h-event:hover,
    .fc-daygrid-event:hover {
      white-space: normal !important; /* allow wrapping */
      width: max-content;            /* fit content width */
      max-width: none;               /* remove width cap */
      z-index: 1000;                 /* bring to front */
    }

    /* ----- Calendar event badge typography ----- */
    .fc-daygrid-event.fc-h-event,
    .fc-daygrid-event {
      font-family: 'Poppins', 'Noto Sans KR', sans-serif !important;
      font-weight: 500 !important; /* lighter weight */
      font-size: 0.8rem !important;
      letter-spacing: -0.015em;
    }
    /* ------------------------------------------ */
  </style>
</head>
<body class="py-4">
  <h1 class="mb-4 d-flex justify-content-between align-items-center">LearnUs Alimi
    <div>
      <a href="/" id="homeBtn" class="btn btn-outline-secondary btn-sm me-1 d-none"><i class="fa-solid fa-house me-1"></i>Main</a>
      <button id="logoutBtn" class="btn btn-outline-secondary btn-sm d-none"><i class="fa-solid fa-arrow-right-from-bracket me-1"></i>Logout</button>
    </div></h1>
  <p id="subtitle" class="mb-4 text-muted">Developed by Ï∞®Ïú†ÏßÑ</p>

  <!-- Login form -->
  <form id="login-form" class="mb-4">
    <h4 class="mb-3">LearnUs Login</h4>
    <div class="input-group mb-3">
      <span class="input-group-text"><i class="fa-solid fa-user"></i></span>
      <input type="text" id="username" class="form-control" placeholder="Student ID" required />
    </div>
    <div class="input-group mb-3">
      <span class="input-group-text"><i class="fa-solid fa-lock"></i></span>
      <input type="password" id="password" class="form-control" placeholder="Password" required />
    </div>
    <div class="col-12 form-check mb-2">
      <input class="form-check-input" type="checkbox" id="rememberMe">
      <label class="form-check-label" for="rememberMe">ÏûêÎèô Î°úÍ∑∏Ïù∏</label>
    </div>
    <div class="col-12 mt-3">
      <button type="submit" class="btn btn-primary w-100">Login</button>
    </div>
    <div id="login-error" class="text-danger mt-2 text-center"></div>
  </form>

  <!-- Todo Lists -->
  <div id="todo-section" class="d-none row g-4 mt-3">
    <div class="col-12 mb-3">
      <h4>ÏãúÏ≤≠Ìï¥Ïïº Ìï† ÎèôÏòÅÏÉÅ</h4>
      <ul id="video-list" class="list-group"></ul>
    </div>
    <div class="col-12">
      <h4>Ï†úÏ∂úÌï¥Ïïº Ìï† Í≥ºÏ†ú</h4>
      <ul id="assign-list" class="list-group"></ul>
    </div>
  </div>

  <!-- Calendar -->
  <div id="calendar" class="d-none"></div>

  <!-- Loading overlay -->
  <div id="loading-overlay">
    <div class="text-center">
      <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
      <p class="mt-3 fw-bold">Î°úÎî© Ï§ë...</p>
    </div>
  </div>

  <!-- Footer -->
  <footer id="footer" class="text-muted small">
    <p class="mb-1">Email: <a href="mailto:yujinc726@yonsei.ac.kr">yujinc726@yonsei.ac.kr</a></p>
    <p class="mb-1">Copyright ¬© 2025 Yujin Cha. All Rights Reserved.</p>
    <p class="mb-0">ÎåÄÍ∏∞Í≥ºÌïôÍ≥º ÌôîÏù¥ÌåÖ!</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.17/index.global.min.js"></script>
  <script>
    const loginForm = document.getElementById('login-form');
    const courseSection = document.getElementById('course-section');
    const courseSelect = document.getElementById('course-select');
    const calendarEl = document.getElementById('calendar');
    const loginError = document.getElementById('login-error');
    const logoutBtn = document.getElementById('logoutBtn');
    const homeBtn = document.getElementById('homeBtn');
    let token = null;
    let calendar = null;
    let remainingInterval = null;

    function formatRemainingTime(dueDate) {
      const now = new Date();
      let diffMs = dueDate - now;
      if (diffMs <= 0) return 'ÎßàÍ∞êÎê®';

      const mins = Math.floor(diffMs / 60000);
      const days = Math.floor(mins / 1440);
      const hours = Math.floor((mins % 1440) / 60);
      const minutes = mins % 60;

      const parts = [];
      if (days) parts.push(`${days}Ïùº`);
      if (hours) parts.push(`${hours}ÏãúÍ∞Ñ`);
      if (days === 0 && minutes) parts.push(`${minutes}Î∂Ñ`);
      return parts.join(' ') + ' ÎÇ®Ïùå';
    }

    function updateRemainingTimes() {
      document.querySelectorAll('.remaining-time').forEach(el => {
        const dueStr = el.dataset.due;
        if (!dueStr) return;
        const dueDate = new Date(dueStr);
        el.textContent = formatRemainingTime(dueDate);

        // Highlight in red when less than 1 day remaining
        const diffMs = dueDate - new Date();
        if (diffMs > 0 && diffMs < 86400000) {
          el.classList.add('text-danger');
        } else {
          el.classList.remove('text-danger');
        }
      });
    }

    function startRemainingUpdater() {
      updateRemainingTimes();
      if (remainingInterval) clearInterval(remainingInterval);
      remainingInterval = setInterval(updateRemainingTimes, 60000); // update every minute
    }

    function showLoading(show) {
      document.getElementById('loading-overlay').style.visibility = show ? 'visible' : 'hidden';
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      try {
        showLoading(true);
        const res = await fetch('/al/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password }),
        });
        if (!res.ok) {
          try {
            const errJson = await res.json();
            throw new Error(errJson.detail || 'Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. LearnUs ÌïôÎ≤à/ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
          } catch {
            throw new Error('Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. LearnUs ÌïôÎ≤à/ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
          }
        }
        const data = await res.json();
        token = data.token;
        const remember = document.getElementById('rememberMe').checked;
        if (remember) {
          localStorage.setItem('al_token', token);
          localStorage.setItem('al_id', username);
          localStorage.setItem('al_pw', password);
        } else {
          localStorage.removeItem('al_token');
          localStorage.removeItem('al_id');
          localStorage.removeItem('al_pw');
        }
        loginForm.classList.add('d-none');
        logoutBtn.classList.remove('d-none');
        homeBtn.classList.remove('d-none');
        await loadAllEvents();
      } catch (err) {
        loginError.textContent = err.message || 'Login failed';
        showLoading(false);
      }
    });

    async function apiGet(path) {
      showLoading(true);
      const res = await fetch(path, { headers: { 'X-Auth-Token': token } });
      if (!res.ok) {
        showLoading(false);
        try {
          const errJson = await res.json();
          throw new Error(errJson.detail || 'ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        } catch {
          throw new Error('ÏöîÏ≤≠Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
        }
      }
      const data = await res.json();
      showLoading(false);
      return data;
    }

    async function loadAllEvents() {
      const data = await apiGet('/al/events');
      renderCalendar(data.calendar);
      renderTodos(data.videos, data.assignments);
    }

    function renderCalendar(events) {
      calendarEl.classList.remove('d-none');
      logoutBtn.classList.remove('d-none');
      homeBtn.classList.remove('d-none');
      if (calendar) {
        calendar.removeAllEvents();
        calendar.addEventSource(events);
        return;
      }
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 'auto',
        events,
        eventColor: '#3788d8',
        eventDidMount: function(info) {
          if (!info.event.extendedProps.completed) {
            info.el.style.fontWeight = 'bold';
            if (info.event.extendedProps.type === 'assign') {
              info.el.style.backgroundColor = '#dc3545';
            }
          }
        }
      });
      calendar.render();
    }

    function renderTodos(videos, assigns) {
      const videoList = document.getElementById('video-list');
      const assignList = document.getElementById('assign-list');

      videoList.innerHTML = videos.length ? '' : '<li class="list-group-item">Î™®Îëê ÏôÑÎ£å!</li>';
      videos.forEach(v => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const a = document.createElement('a');
        a.href = `https://ys.learnus.org/mod/vod/viewer.php?id=${v.id}`;
        a.target = '_blank';
        a.rel = 'noopener';
        a.textContent = v.title;
        a.className = 'text-decoration-none';
        a.addEventListener('click', (e) => {
          e.preventDefault();
          window.open(a.href, '_blank', 'noopener,width=1200,height=800');
        });
        li.appendChild(a);
        const dueBadge = document.createElement('span');
        dueBadge.className = 'badge bg-primary rounded-pill due-time';
        dueBadge.textContent = new Date(v.due).toLocaleString('ko-KR');

        const remainBadge = document.createElement('span');
        remainBadge.className = 'badge rounded-pill remaining-time';
        remainBadge.dataset.due = v.due;

        const rightBox = document.createElement('div');
        rightBox.className = 'd-flex align-items-center gap-2 ms-auto';
        rightBox.appendChild(remainBadge);
        rightBox.appendChild(dueBadge);
        li.appendChild(rightBox);

        videoList.appendChild(li);
      });

      assignList.innerHTML = assigns.length ? '' : '<li class="list-group-item">Î™®Îëê ÏôÑÎ£å!</li>';
      assigns.forEach(a => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        const link = document.createElement('a');
        link.href = `https://ys.learnus.org/mod/assign/view.php?id=${a.id}`;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = a.title;
        link.className = 'text-decoration-none';
        li.appendChild(link);
        const dueBadge = document.createElement('span');
        dueBadge.className = 'badge bg-danger rounded-pill due-time';
        dueBadge.textContent = new Date(a.due).toLocaleString('ko-KR');

        const remainBadge = document.createElement('span');
        remainBadge.className = 'badge rounded-pill remaining-time';
        remainBadge.dataset.due = a.due;

        const rightBox = document.createElement('div');
        rightBox.className = 'd-flex align-items-center gap-2 ms-auto';
        rightBox.appendChild(remainBadge);
        rightBox.appendChild(dueBadge);
        li.appendChild(rightBox);

        assignList.appendChild(li);
      });

      document.getElementById('todo-section').classList.remove('d-none');

      startRemainingUpdater();
    }

    logoutBtn.addEventListener('click', async () => {
      try {
        await fetch('/al/logout', { method: 'POST', headers: { 'X-Auth-Token': token } });
      } catch {}
      localStorage.removeItem('al_token');
      localStorage.removeItem('al_id');
      localStorage.removeItem('al_pw');
      location.reload();
    });

    // Auto login on page load
    window.addEventListener('load', async () => {
      const storedToken = localStorage.getItem('al_token');
      const storedId = localStorage.getItem('al_id');
      const storedPw = localStorage.getItem('al_pw');

      if (storedToken) {
        token = storedToken;
        try {
          await apiGet('/al/ping');
          loginForm.classList.add('d-none');
          logoutBtn.classList.remove('d-none');
          homeBtn.classList.remove('d-none');
          await loadAllEvents();
          return;
        } catch {
          token = null;
          localStorage.removeItem('al_token');
        }
      }

      if (storedId && storedPw) {
        document.getElementById('username').value = storedId;
        document.getElementById('password').value = storedPw;
        document.getElementById('rememberMe').checked = true;
        // auto-submit login form
        loginForm.dispatchEvent(new Event('submit', { cancelable: true }));
      }
    });
  </script>
</body>
</html> 